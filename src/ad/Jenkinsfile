pipeline {
    agent any

    environment {
        TARGET_URL = 'http://jayavardhanreddy616.xyz'
        REPORT_NAME = 'zap_report.html'
        ZAP_IMAGE = 'ghcr.io/zaproxy/zaproxy:stable'
    }

    stages {
        stage('Run ZAP Scan') {
            steps {
                script {
                    sh '''
                        echo "Sleeping 20 seconds to wait for app startup..."
                        sleep 20

                        echo "Running ZAP Baseline Scan on $TARGET_URL"

                        docker run --rm -v $(pwd):/zap/wrk/:rw -t $ZAP_IMAGE zap-baseline.py \
                            -t $TARGET_URL \
                            -r $REPORT_NAME \
                            -n -I || true

                        echo "ZAP Scan completed. Report saved as $REPORT_NAME"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Archiving ZAP report...'
            archiveArtifacts artifacts: "${REPORT_NAME}", allowEmptyArchive: true
        }
    }
}
